import { assertIsNumber } from "/libs/utils";
import { DEFAULT_EXP_FARM_TARGETS, GROW_SCRIPT_NAME, LOG_FOLDER, WEAKEN_SCRIPT_NAME } from "/libs/constants";
import { NetscriptExtension } from "/libs/NetscriptExtension";
function autocomplete(data, flags) {
  return [...data.servers];
}
const defaultConfig = {
  influenceStock: false
};
let customConfig = null;
customConfig = {
  // influenceStock: false,
  influenceStock: true
};
let nsx;
async function main(ns) {
  nsx = new NetscriptExtension(ns);
  nsx.killProcessesSpawnFromSameScript();
  const config = customConfig !== null ? customConfig : defaultConfig;
  ns.disableLog("ALL");
  const farmingThreads = ns.args[0];
  assertIsNumber(farmingThreads);
  let targets = [];
  if (ns.args.length > 1) {
    for (let i = 1; i < ns.args.length; i++) {
      targets.push(ns.args[i]);
    }
  } else {
    targets = DEFAULT_EXP_FARM_TARGETS;
  }
  for (const target of targets) {
    while (true) {
      const growThreads = Math.ceil(
        ns.growthAnalyze(target, ns.getServerMaxMoney(target) / ns.getServerMoneyAvailable(target))
      );
      const growTime = ns.getGrowTime(target);
      if (growThreads > 0) {
        nsx.runScriptOnAvailablePrivateRunners(
          true,
          true,
          true,
          GROW_SCRIPT_NAME,
          growThreads,
          target,
          0
        );
        await ns.sleep(growTime + 1e3);
      }
      const securityReducedPerWeakenThead = ns.weakenAnalyze(1);
      const weakenThreads = Math.ceil(
        (ns.getServerSecurityLevel(target) - ns.getServerMinSecurityLevel(target)) / securityReducedPerWeakenThead
      );
      if (weakenThreads > 0) {
        const weakenTime = ns.getWeakenTime(target);
        nsx.runScriptOnAvailablePrivateRunners(
          true,
          true,
          true,
          WEAKEN_SCRIPT_NAME,
          weakenThreads,
          target,
          0
        );
        await ns.sleep(weakenTime + 1e3);
      }
      if (ns.getServerMoneyAvailable(target) === ns.getServerMaxMoney(target) && ns.getServerSecurityLevel(target) === ns.getServerMinSecurityLevel(target)) {
        break;
      }
    }
  }
  while (true) {
    const farmingThreadsPerTarget = Math.floor(farmingThreads / targets.length);
    const identifierPrefix = "expFarm-";
    for (const target of targets) {
      const logFilename = `${LOG_FOLDER}/${identifierPrefix}${target}.txt`;
      if (nsx.checkRunningProcesses(logFilename).stillHaveRunningProcess) {
        continue;
      }
      const result = nsx.runScriptOnAvailablePrivateRunners(
        true,
        true,
        false,
        GROW_SCRIPT_NAME,
        farmingThreadsPerTarget,
        target,
        0,
        config.influenceStock,
        `${identifierPrefix}${target}-${farmingThreadsPerTarget}`
        // Identifier
      );
      if (!result.success) {
        ns.tprint(`Fail to start all required threads. Target: ${target}. Threads: ${farmingThreadsPerTarget}`);
      }
      ns.write(logFilename, JSON.stringify(result.runnerProcesses), "w");
    }
    await ns.sleep(1e3);
  }
}
export {
  autocomplete,
  main
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vc3JjL2V4cEZhcm0udHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbImltcG9ydCB7QXV0b2NvbXBsZXRlRGF0YSwgTlN9IGZyb20gXCJAbnNcIjtcbmltcG9ydCB7YXNzZXJ0SXNOdW1iZXJ9IGZyb20gXCIvbGlicy91dGlsc1wiO1xuaW1wb3J0IHtERUZBVUxUX0VYUF9GQVJNX1RBUkdFVFMsIEdST1dfU0NSSVBUX05BTUUsIExPR19GT0xERVIsIFdFQUtFTl9TQ1JJUFRfTkFNRX0gZnJvbSBcIi9saWJzL2NvbnN0YW50c1wiO1xuaW1wb3J0IHtOZXRzY3JpcHRFeHRlbnNpb259IGZyb20gXCIvbGlicy9OZXRzY3JpcHRFeHRlbnNpb25cIjtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnVzZWQtdmFyc1xuZXhwb3J0IGZ1bmN0aW9uIGF1dG9jb21wbGV0ZShkYXRhOiBBdXRvY29tcGxldGVEYXRhLCBmbGFnczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIFsuLi5kYXRhLnNlcnZlcnNdO1xufVxuXG5pbnRlcmZhY2UgQ29uZmlnIHtcbiAgICBpbmZsdWVuY2VTdG9jazogYm9vbGVhbjtcbn1cblxuY29uc3QgZGVmYXVsdENvbmZpZzogQ29uZmlnID0ge1xuICAgIGluZmx1ZW5jZVN0b2NrOiBmYWxzZVxufTtcblxubGV0IGN1c3RvbUNvbmZpZzogQ29uZmlnIHwgbnVsbCA9IG51bGw7XG5jdXN0b21Db25maWcgPSA8Q29uZmlnPntcbiAgICAvLyBpbmZsdWVuY2VTdG9jazogZmFsc2UsXG4gICAgaW5mbHVlbmNlU3RvY2s6IHRydWUsXG59O1xuXG5sZXQgbnN4OiBOZXRzY3JpcHRFeHRlbnNpb247XG5cbi8qKlxuICogVXNhZ2U6IHJ1biBleHBGYXJtLmpzIDEwMDAgam9lc2d1bnNcbiAqIEBwYXJhbSBuc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbWFpbihuczogTlMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBuc3ggPSBuZXcgTmV0c2NyaXB0RXh0ZW5zaW9uKG5zKTtcbiAgICBuc3gua2lsbFByb2Nlc3Nlc1NwYXduRnJvbVNhbWVTY3JpcHQoKTtcblxuICAgIGNvbnN0IGNvbmZpZyA9IChjdXN0b21Db25maWcgIT09IG51bGwpID8gY3VzdG9tQ29uZmlnIDogZGVmYXVsdENvbmZpZztcblxuICAgIG5zLmRpc2FibGVMb2coXCJBTExcIik7XG5cbiAgICBjb25zdCBmYXJtaW5nVGhyZWFkcyA9IG5zLmFyZ3NbMF07XG4gICAgYXNzZXJ0SXNOdW1iZXIoZmFybWluZ1RocmVhZHMpO1xuXG4gICAgbGV0IHRhcmdldHM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKG5zLmFyZ3MubGVuZ3RoID4gMSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IG5zLmFyZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRhcmdldHMucHVzaCg8c3RyaW5nPm5zLmFyZ3NbaV0pO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGFyZ2V0cyA9IERFRkFVTFRfRVhQX0ZBUk1fVEFSR0VUUztcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHRhcmdldCBvZiB0YXJnZXRzKSB7XG4gICAgICAgIC8vIFByZXBhcmUgdGFyZ2V0czogZ3JvdyB0byBtYXgsIHdlYWtlbiB0byBtaW5cbiAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgIC8vIEdyb3cgdG8gbWF4IG1vbmV5XG4gICAgICAgICAgICBjb25zdCBncm93VGhyZWFkcyA9IE1hdGguY2VpbChcbiAgICAgICAgICAgICAgICBucy5ncm93dGhBbmFseXplKHRhcmdldCwgbnMuZ2V0U2VydmVyTWF4TW9uZXkodGFyZ2V0KSAvIG5zLmdldFNlcnZlck1vbmV5QXZhaWxhYmxlKHRhcmdldCkpXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc3QgZ3Jvd1RpbWUgPSBucy5nZXRHcm93VGltZSh0YXJnZXQpO1xuICAgICAgICAgICAgaWYgKGdyb3dUaHJlYWRzID4gMCkge1xuICAgICAgICAgICAgICAgIG5zeC5ydW5TY3JpcHRPbkF2YWlsYWJsZVByaXZhdGVSdW5uZXJzKFxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBHUk9XX1NDUklQVF9OQU1FLFxuICAgICAgICAgICAgICAgICAgICBncm93VGhyZWFkcyxcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LFxuICAgICAgICAgICAgICAgICAgICAwXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBhd2FpdCBucy5zbGVlcChncm93VGltZSArIDEwMDApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBSZWR1Y2Ugc2VjdXJpdHkgdG8gbWluIHZhbHVlXG4gICAgICAgICAgICBjb25zdCBzZWN1cml0eVJlZHVjZWRQZXJXZWFrZW5UaGVhZCA9IG5zLndlYWtlbkFuYWx5emUoMSk7XG4gICAgICAgICAgICBjb25zdCB3ZWFrZW5UaHJlYWRzID0gTWF0aC5jZWlsKFxuICAgICAgICAgICAgICAgIChucy5nZXRTZXJ2ZXJTZWN1cml0eUxldmVsKHRhcmdldCkgLSBucy5nZXRTZXJ2ZXJNaW5TZWN1cml0eUxldmVsKHRhcmdldCkpIC8gc2VjdXJpdHlSZWR1Y2VkUGVyV2Vha2VuVGhlYWRcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAod2Vha2VuVGhyZWFkcyA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCB3ZWFrZW5UaW1lID0gbnMuZ2V0V2Vha2VuVGltZSh0YXJnZXQpO1xuICAgICAgICAgICAgICAgIG5zeC5ydW5TY3JpcHRPbkF2YWlsYWJsZVByaXZhdGVSdW5uZXJzKFxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBXRUFLRU5fU0NSSVBUX05BTUUsXG4gICAgICAgICAgICAgICAgICAgIHdlYWtlblRocmVhZHMsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgICAgICAgICAgMFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAod2Vha2VuVGltZSArIDEwMDApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBDaGVjayBpZiBzZXJ2ZXIgaGFzIGJlZW4gcHJlcGFyZWQgc3VjY2Vzc2Z1bGx5XG4gICAgICAgICAgICBpZiAobnMuZ2V0U2VydmVyTW9uZXlBdmFpbGFibGUodGFyZ2V0KSA9PT0gbnMuZ2V0U2VydmVyTWF4TW9uZXkodGFyZ2V0KVxuICAgICAgICAgICAgICAgICYmIG5zLmdldFNlcnZlclNlY3VyaXR5TGV2ZWwodGFyZ2V0KSA9PT0gbnMuZ2V0U2VydmVyTWluU2VjdXJpdHlMZXZlbCh0YXJnZXQpKSB7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDb250aW51b3VzbHkgcnVuIGdyb3cgc2NyaXB0IHRvIGZhcm0gZXhwXG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgY29uc3QgZmFybWluZ1RocmVhZHNQZXJUYXJnZXQgPSBNYXRoLmZsb29yKGZhcm1pbmdUaHJlYWRzIC8gdGFyZ2V0cy5sZW5ndGgpO1xuICAgICAgICBjb25zdCBpZGVudGlmaWVyUHJlZml4ID0gXCJleHBGYXJtLVwiO1xuICAgICAgICBmb3IgKGNvbnN0IHRhcmdldCBvZiB0YXJnZXRzKSB7XG4gICAgICAgICAgICBjb25zdCBsb2dGaWxlbmFtZSA9IGAke0xPR19GT0xERVJ9LyR7aWRlbnRpZmllclByZWZpeH0ke3RhcmdldH0udHh0YDtcbiAgICAgICAgICAgIGlmIChuc3guY2hlY2tSdW5uaW5nUHJvY2Vzc2VzKGxvZ0ZpbGVuYW1lKS5zdGlsbEhhdmVSdW5uaW5nUHJvY2Vzcykge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbnN4LnJ1blNjcmlwdE9uQXZhaWxhYmxlUHJpdmF0ZVJ1bm5lcnMoXG4gICAgICAgICAgICAgICAgdHJ1ZSxcbiAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgIEdST1dfU0NSSVBUX05BTUUsXG4gICAgICAgICAgICAgICAgZmFybWluZ1RocmVhZHNQZXJUYXJnZXQsXG4gICAgICAgICAgICAgICAgdGFyZ2V0LFxuICAgICAgICAgICAgICAgIDAsXG4gICAgICAgICAgICAgICAgY29uZmlnLmluZmx1ZW5jZVN0b2NrLFxuICAgICAgICAgICAgICAgIGAke2lkZW50aWZpZXJQcmVmaXh9JHt0YXJnZXR9LSR7ZmFybWluZ1RocmVhZHNQZXJUYXJnZXR9YCAvLyBJZGVudGlmaWVyXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKCFyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIG5zLnRwcmludChgRmFpbCB0byBzdGFydCBhbGwgcmVxdWlyZWQgdGhyZWFkcy4gVGFyZ2V0OiAke3RhcmdldH0uIFRocmVhZHM6ICR7ZmFybWluZ1RocmVhZHNQZXJUYXJnZXR9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBucy53cml0ZShsb2dGaWxlbmFtZSwgSlNPTi5zdHJpbmdpZnkocmVzdWx0LnJ1bm5lclByb2Nlc3NlcyksIFwid1wiKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBucy5zbGVlcCgxMDAwKTtcbiAgICB9XG59XG4iXSwKICAibWFwcGluZ3MiOiAiQUFDQSxTQUFRLHNCQUFxQjtBQUM3QixTQUFRLDBCQUEwQixrQkFBa0IsWUFBWSww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
